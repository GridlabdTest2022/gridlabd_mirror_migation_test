#!/bin/bash
# 
# This script generates a list of the makefile that must be included to build the gridlabd package
#

PATHNAME=$1
SOURCE=${PATHNAME%/*}
FILENAME=${PATHNAME##*/}
if [ "$2" == "" ]; then
	INCLUDE=${SOURCE:-.}/makefile.inc
else
	INCLUDE="$2"
fi
test "$SOURCE" == "$FILENAME" && SOURCE=.
echo "# gridlabd make configuration" > $INCLUDE
# echo "# COMMAND = $0 $* " >> $INCLUDE
# echo "# UPDATED = $(date)" >> $INCLUDE
# echo "# SOURCE = $SOURCE" >> $INCLUDE
# echo "# FILENAME = $FILENAME" >> $INCLUDE
echo "BUILD_DEPENDS = \$(BUILD).depends/" >> $INCLUDE
for MAKEFILE in $(find ${SOURCE:-.} -name $FILENAME -print); do
	FOLDER=${MAKEFILE%/*}
	if [ "$MAKEFILE" != "$PATHNAME" ]; then
		name=$(echo "${FOLDER/$SOURCE\//}")
		NAME=$(echo "${name}" | tr -c A-Za-z _ | tr a-z A-Z)
		echo "" >> $INCLUDE
		echo "# $MAKEFILE" >> $INCLUDE
		echo "${NAME%_*} = ${FOLDER}/" >> $INCLUDE
		echo "${NAME}BUILD = \$(BUILD)${name}/" >> $INCLUDE
		echo "${NAME}SOURCE = \$(SOURCE)${name}/" >> $INCLUDE
		echo "${NAME}INCLUDE = " >> $INCLUDE
		echo "${NAME}CFLAGS = \$(CFLAGS) \$(CPPFLAGS) \$(CXXFLAGS)" >> $INCLUDE
		echo "${NAME}LDFLAGS = \$(LDFLAGS)" >> $INCLUDE
		echo "${NAME}ARFLAGS = \$(ARFLAGS)" >> $INCLUDE
		echo "${NAME}SOFLAGS = \$(SOFLAGS)" >> $INCLUDE
		echo "${NAME}SOURCES = " >> $INCLUDE
		echo "${NAME}HEADERS = " >> $INCLUDE
		echo "${NAME}OBJECTS = " >> $INCLUDE
		echo "${NAME}PARAMS = " >> $INCLUDE
		echo "include $MAKEFILE" >> $INCLUDE
		echo "BUILD_FOLDERS += \$(BUILD)${name}" >> $INCLUDE
		echo "CLEAN_TARGETS += \$(${NAME}OBJECTS)" >> $INCLUDE
		echo "\$(shell mkdir -p \$(BUILD_DEPENDS)/${name})" >> $INCLUDE
		echo "" >> $INCLUDE
		for CPP in ${FOLDER/$PWD\//}/*.cpp; do
			echo "\$(BUILD_DEPENDS)${CPP}: $(utilities/depends -i $CPP)" >> $INCLUDE
			echo "	touch \$@" >> $INCLUDE
			echo "" >> $INCLUDE
		done
	fi
done
echo $INCLUDE
